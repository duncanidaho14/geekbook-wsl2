name: Pipeline-CI
on:
  push:
    branches: [ main ]
env:
  IMAGE_NAME: duncanidaho/geekbook
jobs: 
  ci:
    runs-on: ubuntu-latest
    container:
      image: duncanidaho/geekbook
      volumes:
        - ${{ github.workspace }}:/database_data
        - ${{ github.workspace }}:/meilisearch_data
        - ${{ github.workspace }}:/certs
        - ${{ github.workspace }}:/mercure_data
        - ${{ github.workspace }}:/mercure_config
    
    steps:
      -  uses: actions/checkout@v2

      - name: Setup PHP Action
        # You may pin to the exact commit or the version.
        # uses: shivammathur/setup-php@a4e22b60bbb9c1021113f2860347b0759f66fe5d
        uses: shivammathur/setup-php@2.30.0
        with:
          # Setup PHP extensions.
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_pgsql, dom, filter, gd, json

      - name: Cache
        uses: actions/cache@v4.0.1
        with:
          # A list of files, directories, and wildcard patterns to cache and restore
          path: |
            vendor
          # An explicit key for restoring and saving the cache
          key: ${{ runner.os }}-${{ hashFiles('composer.lock') }}

      - name: Run docker container to compile assets
        uses: docker://aschmelyun/cleaver:latest
        with:
          args: >-
            -v ${{ github.workspace }}:/var/www/html/
            /bin/sh -c "composer install && npm install && npm run build"
            
      - name: Verify assets
        run: ls -l dist
        
          
        
      -  name: LS
         run: ls
    
